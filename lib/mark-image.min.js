!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).MarkImage=e()}(this,function(){"use strict";function H(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,a,n=i.call(t),r=[];try{for(;(void 0===e||0<e--)&&!(s=n.next()).done;)r.push(s.value)}catch(t){a={error:t}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(a)throw a.error}}return r}var E,t;function e(t){this.el="",this.imageSrc="",this.data=[],this.lock=!1,this.label={show:!0,stroke:"#000",fill:"#fac031"},this.pixel={show:!0,fill:"rgba(0,0,0,0.6)"},this.limitSize={minWidth:10,minHeight:10},this.activeRect={stroke:"#67C23A",lineDash:[4,2],lineDashOffset:2},this.rect={fill:"rgba(247,200,4,0.2)",stroke:"rgba(247,200,4,1)"},this.onload=function(){},this.onselect=function(t,e){},this.onresult=function(t){},this.onwarn=function(t){},this.datasets=[],this.image=new Image,this.canvas=document.createElement("canvas"),this.isFitting=!0,this.scaleStep=0,this.pressType=0,this.originX=0,this.originY=0,this.remember=[],this.merge(this,t),this.datasets=this.initData(this.data),this.image=new Image,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.container=document.querySelector(this.el),this.container.appendChild(this.canvas),this.WIDTH=this.canvas.width=this.container.clientWidth,this.HEIGHT=this.canvas.height=this.container.clientHeight,this.setEvent(),this.image.src=this.imageSrc}return(t=E=E||{})[t.default=0]="default",t[t["nw-resize"]=1]="nw-resize",t[t["n-resize"]=2]="n-resize",t[t["ne-resize"]=3]="ne-resize",t[t["e-resize"]=4]="e-resize",t[t["se-resize"]=5]="se-resize",t[t["s-resize"]=6]="s-resize",t[t["sw-resize"]=7]="sw-resize",t[t["w-resize"]=8]="w-resize",t[t.grab=10]="grab",t[t.move=11]="move",t[t.crosshair=12]="crosshair",Object.defineProperty(e.prototype,"imageScale",{get:function(){return this.IMAGE_HEIGHT/this.IMAGE_ORIGIN_HEIGHT},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selectedRect",{get:function(){return this.datasets.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ctrlPoints",{get:function(){return this.selectedRect?this.calcCtrls(this.selectedRect.coor):[]},enumerable:!1,configurable:!0}),e.prototype.initData=function(t){return this.deepCopy(t).map(function(t,e){return{index:e,active:!1,coor:t}})},e.prototype.merge=function(e,i){var s=this;Object.keys(i).forEach(function(t){"[object Object]"===Object.prototype.toString.call(e[t])&&"[object Object]"===Object.prototype.toString.call(i[t])?s.merge(e[t],i[t]):e[t]=i[t]})},e.prototype.deepCopy=function(t){return JSON.parse(JSON.stringify(t))},e.prototype.calcStep=function(t){t&&(this.scaleStep=100,this.setScale(!1)),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(this.setScale(!1),this.calcStep())},e.prototype.calcCtrls=function(t){var e=H(t,4),i=e[0],s=e[1],t=e[2],e=e[3];return[[i,s],[(t-i)/2+i,s],[t,s],[t,(e-s)/2+s],[t,e],[(t-i)/2+i,e],[i,e],[i,(e-s)/2+s]]},e.prototype.calcData=function(){var t=this.deepCopy(this.datasets);t.sort(function(t,e){return t.index-e.index});t=t.map(function(t){return t.coor.map(function(t){return Math.round(t)})});this.data=t,this.onresult(t)},e.prototype.setEvent=function(){var v=this;this.image.addEventListener("load",function(){v.IMAGE_ORIGIN_WIDTH=v.IMAGE_WIDTH=v.image.width,v.IMAGE_ORIGIN_HEIGHT=v.IMAGE_HEIGHT=v.image.height,v.fitting(),v.onload()}),this.canvas.addEventListener("contextmenu",function(t){t.preventDefault()}),this.canvas.addEventListener("mousedown",function(n){if(1===n.buttons){if(!v.lock){if(v.selectedRect)for(var t=0;t<v.ctrlPoints.length;t++){var e=v.ctrlPoints[t].map(function(t){return t*v.imageScale});if(v.ctx.save(),v.ctx.beginPath(),v.ctx.fillStyle="red",v.ctx.arc(e[0]+v.originX,e[1]+v.originY,5,0,2*Math.PI),v.ctx.restore(),v.ctx.isPointInPath(n.offsetX,n.offsetY))return v.pressType=t+1,void(v.hitPoint={left:n.offsetX-v.originX-e[0],top:n.offsetY-v.originY-e[1]})}if(Math.abs(v.remember[0]-n.offsetX)>=v.limitSize.minWidth&&Math.abs(v.remember[1]-n.offsetY)>=v.limitSize.minHeight)for(var i=0;i<v.datasets.length;i++){var s=function(t){var e=v.datasets[t],i=H(e.coor.map(function(t){return t*v.imageScale}),4),s=i[0],a=i[1],t=i[2],i=i[3];if(v.ctx.save(),v.ctx.rect(s+v.originX,a+v.originY,t-s,i-a),v.ctx.restore(),v.ctx.isPointInPath(n.offsetX,n.offsetY))return v.datasets.forEach(function(t){return t.active=!1}),e.active=!0,v.pressType=11,v.datasets=v.datasets.filter(function(t){return t!==e}),v.datasets.push(e),v.hitPoint={left:n.offsetX-v.originX-s,top:n.offsetY-v.originY-a,right:t-n.offsetX,bottom:i-n.offsetY},v.onselect(e.index,e.coor),{value:void 0}}(i);if("object"==typeof s)return s.value}var a=n.offsetX-v.originX,r=n.offsetY-v.originY;0<=a&&a<=v.IMAGE_WIDTH&&0<=r&&r<=v.IMAGE_HEIGHT&&(v.datasets.forEach(function(t){return t.active=!1}),a=(n.offsetX-v.originX)/v.imageScale,r=(n.offsetY-v.originY)/v.imageScale,v.remember=[n.offsetX,n.offsetY],v.datasets.push({index:v.datasets.length,active:!0,coor:[a,r,a,r]}),v.pressType=12)}}else 2===n.buttons&&(v.hitPoint={left:n.offsetX-v.originX,top:n.offsetY-v.originY},v.pressType=10)}),this.canvas.addEventListener("mousemove",function(t){var e=t.offsetX-v.originX,i=t.offsetY-v.originY;if(0<=e&&e<=v.IMAGE_WIDTH&&0<=i&&i<=v.IMAGE_HEIGHT)if(1===t.buttons){if(v.lock)return;if(12===v.pressType)v.selectedRect.coor[2]=e/v.imageScale,v.selectedRect.coor[3]=i/v.imageScale;else if(11===v.pressType){var s=t.offsetX-v.originX-v.hitPoint.left,a=t.offsetY-v.originY-v.hitPoint.top,n=t.offsetX+v.hitPoint.right,r=t.offsetY+v.hitPoint.bottom;0<=s&&n<=v.IMAGE_WIDTH&&0<=a&&r<=v.IMAGE_HEIGHT&&(v.selectedRect.coor=[s,a,n,r].map(function(t){return t/v.imageScale}))}else if(1<=v.pressType&&v.pressType<=8){var o=[],c=v.selectedRect.coor,h=H(c.map(function(t){return t*v.imageScale}),4),l=h[0],f=h[1],p=h[2],I=h[3],s=t.offsetX-v.originX-v.hitPoint.left,a=t.offsetY-v.originY-v.hitPoint.top;switch(v.pressType){case 1:0<=s&&0<=a&&a<I-v.limitSize.minHeight&&(o=[s/v.imageScale,a/v.imageScale,c[2],c[3]]);break;case 2:0<=a&&a<I&&(o=[c[0],a/v.imageScale,c[2],c[3]]);break;case 3:l<s&&s<=v.IMAGE_WIDTH&&0<=a&&a<I&&(o=[c[0],a/v.imageScale,s/v.imageScale,c[3]]);break;case 4:l<s&&s<=v.IMAGE_WIDTH&&(o=[c[0],c[1],s/v.imageScale,c[3]]);break;case 5:l<s&&f<a&&s<=v.IMAGE_WIDTH&&a<=v.IMAGE_HEIGHT&&(o=[c[0],c[1],s/v.imageScale,a/v.imageScale]);break;case 6:f<a&&a<=v.IMAGE_HEIGHT&&(o=[c[0],c[1],c[2],a/v.imageScale]);break;case 7:0<=s&&s<p&&f<a&&a<=v.IMAGE_HEIGHT&&(o=[s/v.imageScale,c[1],c[2],a/v.imageScale]);break;case 8:0<=s&&s<p&&(o=[s/v.imageScale,c[1],c[2],c[3]])}4===o.length&&o[2]-o[0]>=v.limitSize.minWidth&&o[3]-o[1]>=v.limitSize.minHeight?v.selectedRect.coor=o:v.onwarn("尺寸超限")}v.draw()}else if(2===t.buttons)v.originX=t.offsetX-v.hitPoint.left,v.originY=t.offsetY-v.hitPoint.top,v.draw();else{if(v.selectedRect)for(var u=0;u<v.ctrlPoints.length;u++){var g=v.ctrlPoints[u].map(function(t){return t*v.imageScale});if(v.ctx.save(),v.ctx.beginPath(),v.ctx.arc(g[0]+v.originX,g[1]+v.originY,5,0,2*Math.PI),v.ctx.restore(),v.ctx.isPointInPath(t.offsetX,t.offsetY))return void(v.container.style.cursor=E[u+1])}for(var d=0;d<v.datasets.length;d++){var m=H(v.datasets[d].coor.map(function(t){return t*v.imageScale}),4),s=m[0],a=m[1],n=m[2],r=m[3];if(v.ctx.save(),v.ctx.rect(s+v.originX,a+v.originY,n-s,r-a),v.ctx.restore(),v.ctx.isPointInPath(t.offsetX,t.offsetY))return void(v.container.style.cursor=E[11])}i=t.offsetX-v.originX,h=t.offsetY-v.originY;0<=i&&i<=v.IMAGE_WIDTH&&0<=h&&h<=v.IMAGE_HEIGHT&&(v.container.style.cursor=E[12])}v.container.style.cursor=E[v.pressType]}),this.canvas.addEventListener("mouseup",function(){var t,e;12===v.pressType&&(v.datasets.forEach(function(t){var e=H(t.coor,4),i=e[0],s=e[1],a=e[2],e=e[3];t.coor=[Math.min(i,a),Math.min(s,e),Math.max(i,a),Math.max(s,e)]}),t=(e=v.selectedRect.coor)[2]-e[0],e=e[3]-e[1],t<v.limitSize.minWidth?(v.onwarn("宽度不能小于"+v.limitSize.minWidth),v.remove(v.datasets.length-1),v.datasets.forEach(function(t){return t.active=!1})):e<v.limitSize.minHeight&&(v.onwarn("高度度不能小于"+v.limitSize.minWidth),v.remove(v.datasets.length-1),v.datasets.forEach(function(t){return t.active=!1}))),v.hitPoint=null,v.pressType=0,v.calcData(),v.container.style.cursor=E[v.pressType],v.draw()}),this.canvas.addEventListener("mousewheel",function(t){t.preventDefault(),0<t.deltaY?v.zoomOut():v.zoomIn()}),document.body.addEventListener("keyup",function(t){if(v.selectedRect){var e=H(v.selectedRect.coor,4),i=e[0],s=e[1],a=e[2],n=e[3];switch(t.key){case"Backspace":v.remove(v.selectedRect.index);break;case"ArrowLeft":if(i-1<0)return;v.selectedRect.coor=[i-1,s,a-1,n],v.draw();break;case"ArrowUp":if(s-1<0)return;v.selectedRect.coor=[i,s-1,a,n-1],v.draw();break;case"ArrowRight":if(a+1>v.IMAGE_ORIGIN_WIDTH)return;v.selectedRect.coor=[i+1,s,a+1,n],v.draw();break;case"ArrowDown":if(n+1>v.IMAGE_ORIGIN_HEIGHT)return;v.selectedRect.coor=[i,s+1,a,n+1],v.draw()}v.calcData()}})},e.prototype.paintCtrls=function(t){var e=this,t=t.map(function(t){return t*e.imageScale}),i=this.calcCtrls(t);this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#f00";for(var s=0;s<i.length;s++){var a=i[s];this.ctx.beginPath(),this.ctx.arc(a[0],a[1],3,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(a[0],a[1],3,0,2*Math.PI,!0),this.ctx.stroke()}},e.prototype.paintRectList=function(){for(var e=this,t=this.ctx,i=this.datasets,s=this.originX,a=this.originY,n=0;n<i.length;n++){var r,o,c,h,l=i[n].coor.map(function(t){return t*e.imageScale});t.save(),t.translate(s,a),i[n].active?(t.strokeStyle=this.activeRect.stroke,t.beginPath(),t.lineDashOffset=this.activeRect.lineDashOffset,t.setLineDash(this.activeRect.lineDash),t.moveTo(l[0],l[1]),t.lineTo(l[2],l[1]),t.lineTo(l[2],l[3]),t.lineTo(l[0],l[3]),t.lineTo(l[0],l[1]),t.stroke(),t.setLineDash([])):(t.fillStyle=this.rect.fill,t.fillRect(l[0],l[1],l[2]-l[0],l[3]-l[1]),t.strokeStyle=this.rect.stroke,t.strokeRect(l[0],l[1],l[2]-l[0],l[3]-l[1])),this.label.show&&(12!==this.pressType||12===this.pressType&&n!==i.length-1)&&(t.save(),t.translate(l[0],l[1]),t.fillStyle=this.label.fill,t.fillRect(0,0,30,14),t.fillStyle=this.label.stroke,t.textBaseline="middle",t.textAlign="center",t.fillText(i[n].index+1+"",15,7),t.restore()),i[n].active&&(this.paintCtrls(i[n].coor),this.pixel.show&&(t.save(),c=Math.min(l[0],l[2]),r=Math.min(l[1],l[3]),t.translate(c,r),o=(h=H(i[n].coor,4))[0],l=h[1],c=h[2],h=h[3],l=Math.round(Math.abs(c-o))+"*"+Math.round(Math.abs(h-l)),t.fillStyle=this.pixel.fill,t.fillRect(0,24<r+this.originY?-24:0,t.measureText(l).width+4,20),t.fillStyle="#fff",t.textBaseline="middle",t.textAlign="left",t.fillText(l,2,24<r+this.originY?-15:10),t.restore())),t.restore()}},e.prototype.paintImage=function(){this.ctx.drawImage(this.image,this.originX,this.originY,this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},e.prototype.draw=function(){var e=this;this.clear(),this.paintImage(),this.paintRectList(),this.selectedRect?(clearInterval(this.activeRect.t),this.activeRect.t=setInterval(function(){var t=e.activeRect.lineDashOffset;e.activeRect.lineDashOffset=20<t?0:++t,e.draw()},50)):clearInterval(this.activeRect.t)},e.prototype.fitZoom=function(){this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH))},e.prototype.fitting=function(){this.clear(),this.fitZoom(),this.center(),this.paintImage(),this.paintRectList(),this.isFitting=!0},e.prototype.setScale=function(t){t?this.scaleStep++:this.scaleStep--;t=Math.abs(this.scaleStep);this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH*Math.pow(0<=this.scaleStep?1.05:.95,t),this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT*Math.pow(0<=this.scaleStep?1.05:.95,t)},e.prototype.center=function(){this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2},e.prototype.stayPosition=function(t){this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*t,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*t},e.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},e.prototype.zoomIn=function(){var t=this.IMAGE_WIDTH;this.isFitting&&(this.calcStep(!0),this.isFitting=!1),this.clear(),this.setScale(!0),this.stayPosition(this.IMAGE_WIDTH/t),this.paintImage(),this.paintRectList()},e.prototype.zoomOut=function(){var t=this.IMAGE_WIDTH;this.isFitting&&(this.calcStep(!0),this.isFitting=!1),this.clear(),this.setScale(!1),this.stayPosition(this.IMAGE_WIDTH/t),this.paintImage(),this.paintRectList()},e.prototype.remove=function(t){var e,i=parseInt(t+"");i<0||i>this.datasets.length-1||(e=[],this.datasets.forEach(function(t){t.index<i?e.push(t):t.index>i&&(t.index--,e.push(t))}),this.datasets=e,this.calcData(),this.draw())},e});
