!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).MarkImage=e()}(this,function(){"use strict";function v(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,a,n=i.call(t),r=[];try{for(;(void 0===e||0<e--)&&!(s=n.next()).done;)r.push(s.value)}catch(t){a={error:t}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(a)throw a.error}}return r}var H,t;function e(t){this.el="",this.imageSrc="",this.data=[],this.lock=!1,this.label={show:!0,stroke:"#000",fill:"#fac031"},this.pixel={show:!0,fill:"rgba(0,0,0,0.6)"},this.limitSize={minWidth:10,minHeight:10},this.activeRect={stroke:"#67C23A",lineDash:[4,2],lineDashOffset:2},this.rect={fill:"rgba(247,200,4,0.2)",stroke:"rgba(247,200,4,1)"},this.onload=function(){},this.onselect=function(t,e){},this.onresult=function(t){},this.onwarn=function(t){},this.datasets=[],this.image=new Image,this.canvas=document.createElement("canvas"),this.isFitting=!0,this.scaleStep=0,this.pressType=0,this.originX=0,this.originY=0,this.remember=[],this.merge(this,t),this.datasets=this.initData(this.data),this.image=new Image,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.container=this.el instanceof HTMLElement?this.el:document.querySelector(this.el),this.container.appendChild(this.canvas),this.WIDTH=this.canvas.width=this.container.clientWidth,this.HEIGHT=this.canvas.height=this.container.clientHeight,this.setEvent(),this.image.src=this.imageSrc}return(t=H=H||{})[t.default=0]="default",t[t["nw-resize"]=1]="nw-resize",t[t["n-resize"]=2]="n-resize",t[t["ne-resize"]=3]="ne-resize",t[t["e-resize"]=4]="e-resize",t[t["se-resize"]=5]="se-resize",t[t["s-resize"]=6]="s-resize",t[t["sw-resize"]=7]="sw-resize",t[t["w-resize"]=8]="w-resize",t[t.grab=10]="grab",t[t.move=11]="move",t[t.crosshair=12]="crosshair",Object.defineProperty(e.prototype,"imageScale",{get:function(){return this.IMAGE_HEIGHT/this.IMAGE_ORIGIN_HEIGHT},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selectedRect",{get:function(){return this.datasets.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ctrlPoints",{get:function(){return this.selectedRect?this.calcCtrls(this.selectedRect.coor):[]},enumerable:!1,configurable:!0}),e.prototype.initData=function(t){return this.deepCopy(t).map(function(t,e){return{index:e,active:!1,coor:t}})},e.prototype.merge=function(e,i){var s=this;Object.keys(i).forEach(function(t){"[object Object]"===Object.prototype.toString.call(e[t])&&"[object Object]"===Object.prototype.toString.call(i[t])?s.merge(e[t],i[t]):e[t]=i[t]})},e.prototype.deepCopy=function(t){return JSON.parse(JSON.stringify(t))},e.prototype.calcStep=function(t){t&&(this.scaleStep=100,this.setScale(!1)),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(this.setScale(!1),this.calcStep())},e.prototype.calcCtrls=function(t){var t=v(t,4),e=t[0],i=t[1],s=t[2],t=t[3];return[[e,i],[(s-e)/2+e,i],[s,i],[s,(t-i)/2+i],[s,t],[(s-e)/2+e,t],[e,t],[e,(t-i)/2+i]]},e.prototype.calcData=function(){var t=this.deepCopy(this.datasets),t=(t.sort(function(t,e){return t.index-e.index}),t.map(function(t){return t.coor.map(function(t){return Math.round(t)})}));this.data=t,this.onresult(t)},e.prototype.setEvent=function(){var m=this;this.image.addEventListener("load",function(){m.IMAGE_ORIGIN_WIDTH=m.IMAGE_WIDTH=m.image.width,m.IMAGE_ORIGIN_HEIGHT=m.IMAGE_HEIGHT=m.image.height,m.fitting(),m.onload()}),this.canvas.addEventListener("contextmenu",function(t){t.preventDefault()}),this.canvas.addEventListener("mousedown",function(n){if(1===n.buttons){if(!m.lock){if(m.selectedRect)for(var t=0;t<m.ctrlPoints.length;t++){var e=m.ctrlPoints[t].map(function(t){return t*m.imageScale});if(m.ctx.save(),m.ctx.beginPath(),m.ctx.fillStyle="red",m.ctx.arc(e[0]+m.originX,e[1]+m.originY,5,0,2*Math.PI),m.ctx.restore(),m.ctx.isPointInPath(n.offsetX,n.offsetY))return m.pressType=t+1,void(m.hitPoint={left:n.offsetX-m.originX-e[0],top:n.offsetY-m.originY-e[1]})}if(Math.abs(m.remember[0]-n.offsetX)>=m.limitSize.minWidth&&Math.abs(m.remember[1]-n.offsetY)>=m.limitSize.minHeight)for(var i=0;i<m.datasets.length;i++){var s=function(t){var e=m.datasets[t],t=v(e.coor.map(function(t){return t*m.imageScale}),4),i=t[0],s=t[1],a=t[2],t=t[3];if(m.ctx.save(),m.ctx.rect(i+m.originX,s+m.originY,a-i,t-s),m.ctx.restore(),m.ctx.isPointInPath(n.offsetX,n.offsetY))return m.datasets.forEach(function(t){return t.active=!1}),e.active=!0,m.pressType=11,m.datasets=m.datasets.filter(function(t){return t!==e}),m.datasets.push(e),m.hitPoint={left:n.offsetX-m.originX-i,top:n.offsetY-m.originY-s,right:a-n.offsetX,bottom:t-n.offsetY},m.onselect(e.index,e.coor),{value:void 0}}(i);if("object"==typeof s)return s.value}var a=n.offsetX-m.originX,r=n.offsetY-m.originY;0<=a&&a<=m.IMAGE_WIDTH&&0<=r&&r<=m.IMAGE_HEIGHT&&(m.datasets.forEach(function(t){return t.active=!1}),a=(n.offsetX-m.originX)/m.imageScale,r=(n.offsetY-m.originY)/m.imageScale,m.remember=[n.offsetX,n.offsetY],m.datasets.push({index:m.datasets.length,active:!0,coor:[a,r,a,r]}),m.pressType=12)}}else 2===n.buttons&&(m.hitPoint={left:n.offsetX-m.originX,top:n.offsetY-m.originY},m.pressType=10)}),this.canvas.addEventListener("mousemove",function(t){var e=t.offsetX-m.originX,i=t.offsetY-m.originY;if(0<=e&&e<=m.IMAGE_WIDTH&&0<=i&&i<=m.IMAGE_HEIGHT)if(1===t.buttons){if(m.lock)return;if(12===m.pressType)m.selectedRect.coor[2]=e/m.imageScale,m.selectedRect.coor[3]=i/m.imageScale;else if(11===m.pressType){var s=t.offsetX-m.originX-m.hitPoint.left,a=t.offsetY-m.originY-m.hitPoint.top,n=t.offsetX+m.hitPoint.right,r=t.offsetY+m.hitPoint.bottom;0<=s&&n<=m.IMAGE_WIDTH&&0<=a&&r<=m.IMAGE_HEIGHT&&(m.selectedRect.coor=[s,a,n,r].map(function(t){return t/m.imageScale}))}else if(1<=m.pressType&&m.pressType<=8){var o=[],c=m.selectedRect.coor,e=v(c.map(function(t){return t*m.imageScale}),4),h=e[0],l=e[1],f=e[2],p=e[3],s=t.offsetX-m.originX-m.hitPoint.left,a=t.offsetY-m.originY-m.hitPoint.top;switch(m.pressType){case 1:0<=s&&0<=a&&a<p-m.limitSize.minHeight&&(o=[s/m.imageScale,a/m.imageScale,c[2],c[3]]);break;case 2:0<=a&&a<p&&(o=[c[0],a/m.imageScale,c[2],c[3]]);break;case 3:h<s&&s<=m.IMAGE_WIDTH&&0<=a&&a<p&&(o=[c[0],a/m.imageScale,s/m.imageScale,c[3]]);break;case 4:h<s&&s<=m.IMAGE_WIDTH&&(o=[c[0],c[1],s/m.imageScale,c[3]]);break;case 5:h<s&&l<a&&s<=m.IMAGE_WIDTH&&a<=m.IMAGE_HEIGHT&&(o=[c[0],c[1],s/m.imageScale,a/m.imageScale]);break;case 6:l<a&&a<=m.IMAGE_HEIGHT&&(o=[c[0],c[1],c[2],a/m.imageScale]);break;case 7:0<=s&&s<f&&l<a&&a<=m.IMAGE_HEIGHT&&(o=[s/m.imageScale,c[1],c[2],a/m.imageScale]);break;case 8:0<=s&&s<f&&(o=[s/m.imageScale,c[1],c[2],c[3]])}4===o.length&&o[2]-o[0]>=m.limitSize.minWidth&&o[3]-o[1]>=m.limitSize.minHeight?m.selectedRect.coor=o:m.onwarn("尺寸超限")}m.draw()}else if(2===t.buttons)m.originX=t.offsetX-m.hitPoint.left,m.originY=t.offsetY-m.hitPoint.top,m.draw();else{if(m.selectedRect)for(var I=0;I<m.ctrlPoints.length;I++){var u=m.ctrlPoints[I].map(function(t){return t*m.imageScale});if(m.ctx.save(),m.ctx.beginPath(),m.ctx.arc(u[0]+m.originX,u[1]+m.originY,5,0,2*Math.PI),m.ctx.restore(),m.ctx.isPointInPath(t.offsetX,t.offsetY))return void(m.container.style.cursor=H[I+1])}for(var g=0;g<m.datasets.length;g++){var d=v(m.datasets[g].coor.map(function(t){return t*m.imageScale}),4),s=d[0],a=d[1],n=d[2],r=d[3];if(m.ctx.save(),m.ctx.rect(s+m.originX,a+m.originY,n-s,r-a),m.ctx.restore(),m.ctx.isPointInPath(t.offsetX,t.offsetY))return void(m.container.style.cursor=H[11])}i=t.offsetX-m.originX,e=t.offsetY-m.originY;0<=i&&i<=m.IMAGE_WIDTH&&0<=e&&e<=m.IMAGE_HEIGHT&&(m.container.style.cursor=H[12])}m.container.style.cursor=H[m.pressType]}),this.canvas.addEventListener("mouseup",function(){var t,e;12===m.pressType&&(m.datasets.forEach(function(t){var e=v(t.coor,4),i=e[0],s=e[1],a=e[2],e=e[3];t.coor=[Math.min(i,a),Math.min(s,e),Math.max(i,a),Math.max(s,e)]}),t=(e=m.selectedRect.coor)[2]-e[0],e=e[3]-e[1],t<m.limitSize.minWidth?(m.onwarn("宽度不能小于"+m.limitSize.minWidth),m.remove(m.datasets.length-1),m.datasets.forEach(function(t){return t.active=!1})):e<m.limitSize.minHeight&&(m.onwarn("高度度不能小于"+m.limitSize.minWidth),m.remove(m.datasets.length-1),m.datasets.forEach(function(t){return t.active=!1}))),m.hitPoint=null,m.pressType=0,m.calcData(),m.container.style.cursor=H[m.pressType],m.draw()}),this.canvas.addEventListener("mousewheel",function(t){t.preventDefault(),0<t.deltaY?m.zoomOut():m.zoomIn()}),document.body.addEventListener("keyup",function(t){if(m.selectedRect){var e=v(m.selectedRect.coor,4),i=e[0],s=e[1],a=e[2],n=e[3];switch(t.key){case"Backspace":m.remove(m.selectedRect.index);break;case"ArrowLeft":if(i-1<0)return;m.selectedRect.coor=[i-1,s,a-1,n],m.draw();break;case"ArrowUp":if(s-1<0)return;m.selectedRect.coor=[i,s-1,a,n-1],m.draw();break;case"ArrowRight":if(a+1>m.IMAGE_ORIGIN_WIDTH)return;m.selectedRect.coor=[i+1,s,a+1,n],m.draw();break;case"ArrowDown":if(n+1>m.IMAGE_ORIGIN_HEIGHT)return;m.selectedRect.coor=[i,s+1,a,n+1],m.draw()}m.calcData()}})},e.prototype.paintCtrls=function(t){var e=this,t=t.map(function(t){return t*e.imageScale}),i=this.calcCtrls(t);this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#f00";for(var s=0;s<i.length;s++){var a=i[s];this.ctx.beginPath(),this.ctx.arc(a[0],a[1],3,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(a[0],a[1],3,0,2*Math.PI,!0),this.ctx.stroke()}},e.prototype.paintRectList=function(){for(var e=this,t=this.ctx,i=this.datasets,s=this.originX,a=this.originY,n=0;n<i.length;n++){var r,o,c,h,l=i[n].coor.map(function(t){return t*e.imageScale});t.save(),t.translate(s,a),i[n].active?(t.strokeStyle=this.activeRect.stroke,t.beginPath(),t.lineDashOffset=this.activeRect.lineDashOffset,t.setLineDash(this.activeRect.lineDash),t.moveTo(l[0],l[1]),t.lineTo(l[2],l[1]),t.lineTo(l[2],l[3]),t.lineTo(l[0],l[3]),t.lineTo(l[0],l[1]),t.stroke(),t.setLineDash([])):(t.fillStyle=this.rect.fill,t.fillRect(l[0],l[1],l[2]-l[0],l[3]-l[1]),t.strokeStyle=this.rect.stroke,t.strokeRect(l[0],l[1],l[2]-l[0],l[3]-l[1])),this.label.show&&(12!==this.pressType||12===this.pressType&&n!==i.length-1)&&(t.save(),t.translate(l[0],l[1]),t.fillStyle=this.label.fill,t.fillRect(0,0,30,14),t.fillStyle=this.label.stroke,t.textBaseline="middle",t.textAlign="center",t.fillText(i[n].index+1+"",15,7),t.restore()),i[n].active&&(this.paintCtrls(i[n].coor),this.pixel.show)&&(t.save(),c=Math.min(l[0],l[2]),l=Math.min(l[1],l[3]),t.translate(c,l),r=(c=v(i[n].coor,4))[0],o=c[1],h=c[2],c=c[3],h="".concat(Math.round(Math.abs(h-r)),"*").concat(Math.round(Math.abs(c-o))),t.fillStyle=this.pixel.fill,t.fillRect(0,24<l+this.originY?-24:0,t.measureText(h).width+4,20),t.fillStyle="#fff",t.textBaseline="middle",t.textAlign="left",t.fillText(h,2,24<l+this.originY?-15:10),t.restore()),t.restore()}},e.prototype.paintImage=function(){this.ctx.drawImage(this.image,this.originX,this.originY,this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},e.prototype.draw=function(){var e=this;this.clear(),this.paintImage(),this.paintRectList(),this.selectedRect?(clearInterval(this.activeRect.t),this.activeRect.t=setInterval(function(){var t=e.activeRect.lineDashOffset;e.activeRect.lineDashOffset=20<t?0:++t,e.draw()},50)):clearInterval(this.activeRect.t)},e.prototype.fitZoom=function(){this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH))},e.prototype.fitting=function(){this.clear(),this.fitZoom(),this.center(),this.paintImage(),this.paintRectList(),this.isFitting=!0},e.prototype.setScale=function(t){t?this.scaleStep++:this.scaleStep--;t=Math.abs(this.scaleStep);this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH*Math.pow(0<=this.scaleStep?1.05:.95,t),this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT*Math.pow(0<=this.scaleStep?1.05:.95,t)},e.prototype.center=function(){this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2},e.prototype.stayPosition=function(t){this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*t,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*t},e.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},e.prototype.zoomIn=function(){var t=this.IMAGE_WIDTH;this.isFitting&&(this.calcStep(!0),this.isFitting=!1),this.clear(),this.setScale(!0),this.stayPosition(this.IMAGE_WIDTH/t),this.paintImage(),this.paintRectList()},e.prototype.zoomOut=function(){var t=this.IMAGE_WIDTH;this.isFitting&&(this.calcStep(!0),this.isFitting=!1),this.clear(),this.setScale(!1),this.stayPosition(this.IMAGE_WIDTH/t),this.paintImage(),this.paintRectList()},e.prototype.remove=function(t){var e,i=parseInt(t+"");i<0||i>this.datasets.length-1||(e=[],this.datasets.forEach(function(t){t.index<i?e.push(t):t.index>i&&(t.index--,e.push(t))}),this.datasets=e,this.calcData(),this.draw())},e});
